{% extends "layout.html" %}
{% block title %}Leil√£o Online{% endblock %}
{% block content %}
<h2>Produtos</h2>

<div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:20px;">
{% for produto in produtos %}
<div class="produto" data-id="{{ produto.id }}" style="background:white; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <img src="{{ produto.imagem }}" alt="{{ produto.nome }}" style="width:100%; border-radius:10px; margin-bottom:10px;">
    <h3>{{ produto.nome }} - R$ {{ produto.preco }}</h3>
    <p>{{ produto.descricao }}</p>
    <a href="{{ url_for('finalizar_compra', produto_id=produto.id) }}">
        <button style="background:#1877f2;color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">Fazer Compra</button>
    </a>

    <div class="chat" style="border:1px solid #ccc; border-radius:8px; padding:10px; max-height:220px; overflow-y:auto; margin-top:10px; background:#f9f9f9; display:flex; flex-direction:column-reverse;">
        {% for msg in produto.mensagens %}
        <div class="mensagem {% if msg.autor=='usuario' %}usuario{% else %}vendedor{% endif %}">{{ msg.texto }}</div>
        {% endfor %}
    </div>
    <div style="display:flex; margin-top:5px;">
        <input type="text" class="input-chat" placeholder="Digite sua mensagem..." style="flex:1; padding:8px 12px; border-radius:20px; border:1px solid #ccc;">
        <button class="botao-enviar" style="margin-left:5px; padding:8px 15px; border-radius:20px; border:none; background:#1877f2; color:white; cursor:pointer;">Enviar</button>
    </div>
</div>
{% endfor %}
</div>

<style>
.mensagem { 
    padding:10px 15px; 
    margin:5px 0; 
    border-radius:20px; 
    max-width:70%; 
    word-wrap: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-size: 0.95em;
}
.usuario { background:#DCF8C6; align-self:flex-start; }
.vendedor { background:#ffffff; align-self:flex-end; }
</style>

<script>
document.querySelectorAll('.botao-enviar').forEach(btn=>{
    btn.onclick = ()=>{
        const produtoDiv = btn.closest('.produto');
        const id = produtoDiv.dataset.id;
        const input = produtoDiv.querySelector('.input-chat');
        const texto = input.value.trim();
        if(texto==="") return;

        fetch(`/nova_mensagem/${id}`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({texto})
        }).then(res=>res.json()).then(mensagens=>{
            const chat = produtoDiv.querySelector('.chat');
            chat.innerHTML = '';
            mensagens.forEach(m=>{
                const div = document.createElement('div');
                div.className = 'mensagem ' + (m.autor==='usuario'?'usuario':'vendedor');
                div.textContent = m.texto;
                chat.appendChild(div);
            });
            input.value = '';
            input.focus();
        });
    };
});
</script>
{% endblock %}